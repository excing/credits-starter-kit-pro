# 管理员功能使用指南

## 概述

管理员控制台提供了完整的积分系统管理功能，包括套餐管理、兑换码管理和欠费管理。

---

## 访问权限

### 管理员验证
- 管理员邮箱通过环境变量 `ADMIN_EMAIL` 配置
- 只有匹配的邮箱才能访问管理员功能
- 访问路径：`/dashboard/admin`

### 配置方法
```bash
# .env 文件
ADMIN_EMAIL=admin@example.com
```

---

## 功能模块

### 1. 统计仪表板

管理员页面顶部显示4个关键指标：

#### 积分套餐
- **显示内容**：当前可用套餐数量
- **说明**：包括所有已创建的套餐（激活和停用）

#### 兑换码
- **显示内容**：已生成兑换码数量
- **说明**：包括所有兑换码（有效、已过期、已禁用）

#### 未结清欠费
- **显示内容**：待处理欠费记录数量
- **说明**：需要关注的欠费用户数量

#### 欠费总额
- **显示内容**：未结清积分总额
- **说明**：所有未结清欠费的积分总和

---

### 2. 套餐管理

#### 创建套餐

**步骤**：
1. 点击右上角"创建套餐"按钮
2. 填写套餐信息：
   - **套餐名称**（必填）：例如"新手礼包"
   - **套餐类型**（必填）：例如"welcome"、"standard"、"premium"
   - **套餐描述**（可选）：详细说明
   - **积分数量**（必填）：套餐包含的积分数
   - **有效期**（必填）：套餐有效天数
   - **价格**（可选）：以分为单位，0表示免费
   - **货币**（可选）：默认CNY
   - **激活状态**：是否立即激活
3. 点击"创建套餐"

**示例**：
```
套餐名称：新手礼包
套餐类型：welcome
积分数量：100
有效期：30天
价格：0（免费）
```

#### 编辑套餐

**步骤**：
1. 在套餐列表中找到要编辑的套餐
2. 点击"编辑"按钮（铅笔图标）
3. 修改套餐信息
4. 点击"保存修改"

**注意**：
- 修改套餐不会影响已发放的用户套餐
- 只影响新发放的套餐

#### 删除套餐

**步骤**：
1. 在套餐列表中找到要删除的套餐
2. 点击"删除"按钮（垃圾桶图标）
3. 确认删除操作

**警告**：
- 删除操作不可撤销
- 已发放的用户套餐不受影响
- 关联的兑换码将无法使用

#### 套餐列表说明

| 列 | 说明 |
|---|---|
| 套餐名称 | 套餐的显示名称 |
| 积分数 | 套餐包含的积分数量 |
| 有效期 | 套餐有效天数 |
| 价格 | 套餐价格（分），0表示免费 |
| 类型 | 套餐类型标识 |
| 状态 | 激活/停用 |
| 操作 | 编辑/删除按钮 |

---

### 3. 兑换码管理

#### 生成兑换码

**步骤**：
1. 点击右上角"生成兑换码"按钮
2. 配置兑换码参数：
   - **选择套餐**：选择要关联的套餐
   - **生成数量**：1-100个（批量生成）
   - **最大使用次数**：
     - 1 = 单次使用（一码一用）
     - N = 可用N次（多次使用）
   - **兑换码有效期**：1-365天
3. 点击"生成兑换码"
4. 复制生成的兑换码

**批量生成**：
- 一次最多生成100个兑换码
- 所有兑换码使用相同的配置
- 每个兑换码都是唯一的UUID

**复制功能**：
- 单个复制：点击每个兑换码旁边的复制按钮
- 批量复制：点击"复制所有兑换码"按钮

#### 兑换码列表

**显示信息**：
- **兑换码**：UUID格式的兑换码
- **套餐**：关联的套餐名称和积分数
- **使用情况**：已使用次数/最大使用次数
- **过期时间**：兑换码本身的过期时间
- **状态**：有效/已过期/已禁用

**操作**：
- **禁用/启用**：切换兑换码的激活状态
- **删除**：永久删除兑换码

#### 兑换码状态说明

| 状态 | 说明 | 可用性 |
|---|---|---|
| 有效 | 激活且未过期 | ✅ 可用 |
| 已过期 | 超过过期时间 | ❌ 不可用 |
| 已禁用 | 管理员手动禁用 | ❌ 不可用 |

---

### 4. 欠费管理

#### 查看欠费记录

**过滤选项**：
- **未结清**：显示所有未结清的欠费（默认）
- **已结清**：显示所有已结清的欠费
- **全部**：显示所有欠费记录

**列表信息**：
- **用户ID**：欠费用户的ID（显示前8位）
- **欠费金额**：欠费的积分数量
- **操作类型**：导致欠费的操作（如chat_usage）
- **创建时间**：欠费产生的时间
- **状态**：已结清/未结清
- **结清时间**：欠费结清的时间

#### 手动结清欠费

**使用场景**：
- 用户无法充值但需要豁免欠费
- 系统错误导致的欠费
- 特殊情况下的欠费处理

**步骤**：
1. 在欠费列表中找到要结清的记录
2. 点击"手动结清"按钮
3. 确认操作

**效果**：
- 欠费状态变为"已结清"
- 记录结清时间
- 不扣除用户积分（管理员豁免）

#### 自动结算说明

**触发时机**：
- 用户兑换积分时
- 用户充值时
- 管理员发放积分时

**结算规则**：
- 按欠费创建时间排序（FIFO）
- 优先结清早期欠费
- 支持部分结清
- 在事务中执行，保证一致性

**示例**：
```
用户有3笔欠费：
1. 30积分（chat_usage）
2. 20积分（image_generation）
3. 50积分（file_processing）

用户充值60积分：
- 第1笔欠费：完全结清（30积分）
- 第2笔欠费：完全结清（20积分）
- 第3笔欠费：部分结清（10积分），剩余40积分
- 用户最终余额：0积分
```

---

## 使用流程

### 场景1：发放新手礼包

**目标**：为新用户提供100积分的新手礼包

**步骤**：
1. 创建套餐：
   - 名称：新手礼包
   - 类型：welcome
   - 积分：100
   - 有效期：30天
   - 价格：0（免费）

2. 生成兑换码：
   - 选择"新手礼包"
   - 生成数量：50
   - 最大使用次数：1
   - 有效期：90天

3. 分发兑换码：
   - 复制所有兑换码
   - 通过邮件/社交媒体发送给用户

4. 用户兑换：
   - 用户在 `/dashboard/credits` 页面输入兑换码
   - 自动获得100积分，有效期30天

### 场景2：处理用户欠费

**情况**：用户因余额不足产生欠费

**自动处理**：
1. 用户操作时余额不足
2. 系统自动扣除现有余额
3. 不足部分记录为欠费
4. 用户充值时自动结算欠费

**手动处理**：
1. 在欠费管理中查看未结清欠费
2. 评估欠费原因
3. 如需豁免，点击"手动结清"
4. 欠费状态变为已结清

### 场景3：批量生成促销码

**目标**：为促销活动生成100个兑换码

**步骤**：
1. 创建促销套餐：
   - 名称：双十一特惠
   - 积分：500
   - 有效期：60天
   - 价格：4900（¥49.00）

2. 生成兑换码：
   - 选择"双十一特惠"
   - 生成数量：100
   - 最大使用次数：1
   - 有效期：30天

3. 导出兑换码：
   - 点击"复制所有兑换码"
   - 粘贴到Excel或文本文件
   - 用于促销活动分发

---

## 注意事项

### 安全性

1. **管理员权限**
   - 只有配置的管理员邮箱才能访问
   - 定期更换管理员密码
   - 不要共享管理员账号

2. **兑换码安全**
   - 兑换码是UUID格式，难以猜测
   - 设置合理的有效期
   - 及时禁用泄露的兑换码

3. **欠费管理**
   - 手动结清需谨慎操作
   - 记录结清原因
   - 定期审查欠费记录

### 最佳实践

1. **套餐命名**
   - 使用清晰的命名规则
   - 包含积分数量和用途
   - 例如："新手礼包-100积分"

2. **兑换码管理**
   - 批量生成时记录用途
   - 定期清理过期兑换码
   - 监控兑换码使用情况

3. **欠费监控**
   - 定期查看未结清欠费
   - 关注欠费总额变化
   - 分析欠费产生原因

4. **数据备份**
   - 定期导出兑换码列表
   - 备份重要套餐配置
   - 记录重要操作日志

---

## 常见问题

### Q1: 如何修改已发放的套餐？
**A**: 无法修改已发放的套餐。编辑套餐只影响新发放的套餐。如需调整用户积分，可以：
- 创建新套餐并生成兑换码
- 让用户兑换新的兑换码

### Q2: 兑换码可以重复使用吗？
**A**: 取决于"最大使用次数"设置：
- 设置为1：一码一用，兑换后失效
- 设置为N：可用N次，达到次数后失效

### Q3: 用户欠费会影响使用吗？
**A**: 当前实现不会阻止用户继续使用。欠费只是记录，用户充值时会自动结算。如需限制，可以在代码中添加欠费上限检查。

### Q4: 如何查看某个用户的欠费？
**A**: 当前版本显示所有用户的欠费。可以通过用户ID前缀进行筛选。未来版本会添加用户搜索功能。

### Q5: 删除套餐会影响已发放的积分吗？
**A**: 不会。删除套餐只影响：
- 无法再生成该套餐的兑换码
- 已发放的用户套餐不受影响
- 用户可以继续使用已获得的积分

### Q6: 兑换码过期后可以恢复吗？
**A**: 不能直接恢复。但可以：
- 生成新的兑换码
- 或者修改数据库中的过期时间（不推荐）

### Q7: 如何批量禁用兑换码？
**A**: 当前需要逐个禁用。如需批量操作，可以：
- 直接在数据库中更新
- 或联系开发人员添加批量操作功能

---

## API接口

管理员功能使用以下API接口：

### 套餐管理
- `GET /api/admin/credits/packages` - 获取套餐列表
- `POST /api/admin/credits/packages` - 创建套餐
- `PUT /api/admin/credits/packages/[id]` - 更新套餐
- `DELETE /api/admin/credits/packages/[id]` - 删除套餐

### 兑换码管理
- `GET /api/admin/credits/codes` - 获取兑换码列表
- `POST /api/admin/credits/generate-code` - 生成兑换码
- `PATCH /api/admin/credits/codes/[id]` - 启用/禁用兑换码
- `DELETE /api/admin/credits/codes/[id]` - 删除兑换码

### 欠费管理
- `GET /api/admin/credits/debts` - 获取欠费列表
- `POST /api/admin/credits/debts/[id]/settle` - 手动结清欠费

---

## 技术支持

如有问题或建议，请：
1. 查看详细技术文档
2. 检查系统日志
3. 联系技术支持团队

---

**文档版本**: v1.0.0
**更新日期**: 2026-02-06
**适用版本**: Credits Starter Kit v1.1.0
